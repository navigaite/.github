---
name: Universal CI/CD Pipeline v2
# This is a reusable workflow that provides a complete CI/CD pipeline for any tech stack
# Call this workflow from your project's workflow file

on:
  workflow_call:
    inputs:
      config-file:
        description: Path to pipeline configuration file
        required: false
        type: string
        default: .github/pipeline.yaml

      working-directory:
        description: Working directory for all operations
        required: false
        type: string
        default: .

      # Override options (bypass config file)
      stack:
        description: Force specific tech stack (overrides config and auto-detection)
        required: false
        type: string
        default: ''

      skip-security:
        description: Skip security scanning
        required: false
        type: boolean
        default: false

      skip-lint:
        description: Skip linting
        required: false
        type: boolean
        default: false

      skip-test:
        description: Skip tests
        required: false
        type: boolean
        default: false

      skip-build:
        description: Skip build
        required: false
        type: boolean
        default: false

      skip-deploy:
        description: Skip deployment
        required: false
        type: boolean
        default: false

    secrets:
      # Vercel secrets
      VERCEL_TOKEN:
        required: false
      VERCEL_ORG_ID:
        required: false
      VERCEL_PROJECT_ID:
        required: false

      # DigitalOcean secrets
      DIGITALOCEAN_TOKEN:
        required: false

      # Docker registry secrets
      DOCKER_REGISTRY_USERNAME:
        required: false
      DOCKER_REGISTRY_PASSWORD:
        required: false

      # GitHub token (for deployments and release-please)
      GH_TOKEN:
        required: false

      # Infisical Universal Auth for loading secrets at build-time
      INFISICAL_CLIENT_ID:
        required: false
      INFISICAL_CLIENT_SECRET:
        required: false
      INFISICAL_PROJECT_SLUG:
        required: false
      INFISICAL_ENV_SLUG:
        required: false
      INFISICAL_DOMAIN:
        required: false
      INFISICAL_SECRET_PATH:
        required: false

# NOTE: Calling workflows must grant the permissions each job actually uses:
#   setup:     contents: read
#   security:  contents: read, pull-requests: write
#   lint/test: contents: read
#   build:     contents: read, id-token: write, attestations: write
#   deploy:    contents: read, deployments: write, pull-requests: write, packages: write, id-token: write
#   release:   contents: write, pull-requests: write, id-token: write
#   sync:      contents: write, pull-requests: write
permissions: {}

concurrency:
  group: ${{ github.repository }}-pipeline-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # =============================================================================
  # CONFIGURATION & SETUP
  # =============================================================================
  setup:
    name: üîß Setup & Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      # Tech stack detection
      stack: ${{ steps.setup-env.outputs.detected-stack }}
      runtime-version: ${{ steps.setup-env.outputs.runtime-version }}
      package-manager: ${{ steps.setup-env.outputs.package-manager }}

      # Pipeline configuration
      enable-security: ${{ steps.parse-config.outputs.enable-security }}
      enable-lint: ${{ steps.parse-config.outputs.enable-lint }}
      enable-test: ${{ steps.parse-config.outputs.enable-test }}
      enable-build: ${{ steps.parse-config.outputs.enable-build }}
      enable-deploy: ${{ steps.parse-config.outputs.enable-deploy }}
      enable-release: ${{ steps.parse-config.outputs.enable-release }}

      # Deployment configuration
      deploy-provider: ${{ steps.parse-config.outputs.deploy-provider }}
      deploy-environments: ${{ steps.parse-config.outputs.deploy-environments }}

      # Release configuration
      enable-sync: ${{ steps.parse-config.outputs.enable-sync }}
      sync-target-branch: ${{ steps.parse-config.outputs.sync-target-branch }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üîç Setup Environment
        id: setup-env
        uses: navigaite/.github/.github/actions/setup-environment@main
        with:
          stack: ${{ inputs.stack || 'auto' }}
          write-summary: 'false'

      - name: üìã Parse Configuration
        id: parse-config
        shell: bash
        env:
          CONFIG_FILE: ${{ inputs.config-file }}
          SKIP_SECURITY: ${{ inputs.skip-security }}
          SKIP_LINT: ${{ inputs.skip-lint }}
          SKIP_TEST: ${{ inputs.skip-test }}
          SKIP_BUILD: ${{ inputs.skip-build }}
          SKIP_DEPLOY: ${{ inputs.skip-deploy }}
        run: |
          echo "::group::üìã Parsing Pipeline Configuration"

          # Check if config file exists
          if [[ ! -f "$CONFIG_FILE" ]]; then
            echo "::warning::Configuration file not found at $CONFIG_FILE, using defaults"

            # Set sensible defaults
            echo "enable-security=true" >> $GITHUB_OUTPUT
            echo "enable-lint=true" >> $GITHUB_OUTPUT
            echo "enable-test=true" >> $GITHUB_OUTPUT
            echo "enable-build=true" >> $GITHUB_OUTPUT
            echo "enable-deploy=false" >> $GITHUB_OUTPUT
            echo "enable-release=false" >> $GITHUB_OUTPUT
            echo "deploy-provider=none" >> $GITHUB_OUTPUT
            echo "deploy-environments=[]" >> $GITHUB_OUTPUT
            echo "enable-sync=true" >> $GITHUB_OUTPUT
            echo "sync-target-branch=dev" >> $GITHUB_OUTPUT
          else
            echo "‚úì Found configuration file: $CONFIG_FILE"

            # Parse configuration using yq
            ENABLE_SECURITY=$(yq '.security.enable // true' "$CONFIG_FILE")
            ENABLE_LINT=$(yq '.lint.enable // true' "$CONFIG_FILE")
            ENABLE_TEST=$(yq '.test.enable // true' "$CONFIG_FILE")
            ENABLE_BUILD=$(yq '.build.enable // true' "$CONFIG_FILE")
            DEPLOY_PROVIDER=$(yq '.deployment.provider // "none"' "$CONFIG_FILE")
            ENABLE_DEPLOY=$([ "$DEPLOY_PROVIDER" != "none" ] && echo "true" || echo "false")
            ENABLE_RELEASE=$(yq '.release.enable // false' "$CONFIG_FILE")

            # Extract release sync configuration
            ENABLE_SYNC=$(yq '.release.sync_to_dev // true' "$CONFIG_FILE")
            SYNC_TARGET=$(yq '.release.sync_target_branch // "dev"' "$CONFIG_FILE")

            # Extract deployment environments
            DEPLOY_ENVS=$(yq -o=json '.deployment.environments // []' "$CONFIG_FILE")

            # Filter environments by trigger event + branch (uses .trigger.event / .trigger.branch)
            # Environments without a trigger field are always included
            CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
            DEPLOY_ENVS=$(echo "$DEPLOY_ENVS" | jq -c \
              --arg event "$GITHUB_EVENT_NAME" \
              --arg branch "$CURRENT_BRANCH" \
              '[.[] | select(
                .trigger == null or (
                  .trigger.event == $event and
                  (if .trigger.branch then .trigger.branch == $branch else true end)
                )
              )]')

            # Apply input overrides
            [[ "$SKIP_SECURITY" == "true" ]] && ENABLE_SECURITY="false"
            [[ "$SKIP_LINT" == "true" ]] && ENABLE_LINT="false"
            [[ "$SKIP_TEST" == "true" ]] && ENABLE_TEST="false"
            [[ "$SKIP_BUILD" == "true" ]] && ENABLE_BUILD="false"
            [[ "$SKIP_DEPLOY" == "true" ]] && ENABLE_DEPLOY="false"

            # Output configuration
            echo "enable-security=$ENABLE_SECURITY" >> $GITHUB_OUTPUT
            echo "enable-lint=$ENABLE_LINT" >> $GITHUB_OUTPUT
            echo "enable-test=$ENABLE_TEST" >> $GITHUB_OUTPUT
            echo "enable-build=$ENABLE_BUILD" >> $GITHUB_OUTPUT
            echo "enable-deploy=$ENABLE_DEPLOY" >> $GITHUB_OUTPUT
            echo "enable-release=$ENABLE_RELEASE" >> $GITHUB_OUTPUT
            echo "deploy-provider=$DEPLOY_PROVIDER" >> $GITHUB_OUTPUT
            echo "deploy-environments=$DEPLOY_ENVS" >> $GITHUB_OUTPUT
            echo "enable-sync=$ENABLE_SYNC" >> $GITHUB_OUTPUT
            echo "sync-target-branch=$SYNC_TARGET" >> $GITHUB_OUTPUT

            echo ""
            echo "üì¶ Configuration Summary:"
            echo "  Security: $ENABLE_SECURITY"
            echo "  Lint: $ENABLE_LINT"
            echo "  Test: $ENABLE_TEST"
            echo "  Build: $ENABLE_BUILD"
            echo "  Deploy: $ENABLE_DEPLOY (Provider: $DEPLOY_PROVIDER)"
            echo "  Release: $ENABLE_RELEASE"
          fi

          echo "::endgroup::"

      - name: üìä Pipeline Summary
        shell: bash
        env:
          STACK: ${{ steps.setup-env.outputs.detected-stack }}
          RUNTIME_VERSION: ${{ steps.setup-env.outputs.runtime-version }}
          PKG_MANAGER: ${{ steps.setup-env.outputs.package-manager }}
          ENABLE_SECURITY: ${{ steps.parse-config.outputs.enable-security }}
          ENABLE_LINT: ${{ steps.parse-config.outputs.enable-lint }}
          ENABLE_TEST: ${{ steps.parse-config.outputs.enable-test }}
          ENABLE_BUILD: ${{ steps.parse-config.outputs.enable-build }}
          ENABLE_DEPLOY: ${{ steps.parse-config.outputs.enable-deploy }}
          ENABLE_RELEASE: ${{ steps.parse-config.outputs.enable-release }}
        run: |
          echo "## üöÄ Pipeline Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Stack | \`$STACK\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime | \`$RUNTIME_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Manager | \`$PKG_MANAGER\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stages" >> $GITHUB_STEP_SUMMARY
          SECURITY=$([[ "$ENABLE_SECURITY" == "true" ]] && echo "‚úÖ" || echo "‚è≠Ô∏è")
          LINT=$([[ "$ENABLE_LINT" == "true" ]] && echo "‚úÖ" || echo "‚è≠Ô∏è")
          TEST=$([[ "$ENABLE_TEST" == "true" ]] && echo "‚úÖ" || echo "‚è≠Ô∏è")
          BUILD=$([[ "$ENABLE_BUILD" == "true" ]] && echo "‚úÖ" || echo "‚è≠Ô∏è")
          DEPLOY=$([[ "$ENABLE_DEPLOY" == "true" ]] && echo "‚úÖ" || echo "‚è≠Ô∏è")
          RELEASE=$([[ "$ENABLE_RELEASE" == "true" ]] && echo "‚úÖ" || echo "‚è≠Ô∏è")
          echo "- **Security Scan:** $SECURITY" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint:** $LINT" >> $GITHUB_STEP_SUMMARY
          echo "- **Test:** $TEST" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** $BUILD" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy:** $DEPLOY" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** $RELEASE" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # SECURITY SCANNING
  # =============================================================================
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    needs: setup
    if: needs.setup.outputs.enable-security == 'true'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0 # Required for TruffleHog

      - name: üîç Security Scanning
        uses: navigaite/.github/.github/actions/security-scan@main

  # =============================================================================
  # LINT
  # =============================================================================
  lint:
    name: üßπ Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    needs: setup
    if: needs.setup.outputs.enable-lint == 'true'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üîß Setup Environment
        uses: navigaite/.github/.github/actions/setup-environment@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          node-version: ${{ needs.setup.outputs.runtime-version }}
          write-summary: 'false'

      - name: üì¶ Install Dependencies
        uses: navigaite/.github/.github/actions/install-dependencies@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          package-manager: ${{ needs.setup.outputs.package-manager }}
          write-summary: 'false'

      - name: üîç Detect React Project
        id: detect-react
        if: needs.setup.outputs.stack == 'nodejs'
        shell: bash
        run: |
          if [[ ! -f package.json ]]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          HAS_REACT=$(jq -r '((.dependencies // {}) + (.devDependencies // {}) + (.peerDependencies // {})) | has("react")' package.json)
          if [[ "$HAS_REACT" == "true" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            echo "‚úì React project detected"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è Not a React project, skipping React Doctor"
          fi

      - name: ü©∫ Run React Doctor (PR)
        id: react-doctor-pr
        if: steps.detect-react.outputs.enabled == 'true' && github.event_name == 'pull_request'
        uses: millionco/react-doctor@97b21f18ee4c5b530d683ae6626548081a4aad76 # main
        continue-on-error: true
        with:
          diff: ${{ github.base_ref || 'main' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ü©∫ Run React Doctor
        id: react-doctor
        if: steps.detect-react.outputs.enabled == 'true' && github.event_name != 'pull_request'
        uses: millionco/react-doctor@97b21f18ee4c5b530d683ae6626548081a4aad76 # main
        continue-on-error: true

      - name: üîç Detect Trunk Configuration
        id: detect-trunk
        shell: bash
        run: |
          if [[ -f ".trunk/trunk.yaml" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ü©∫ React Doctor Summary
        if: always() && steps.detect-react.outputs.enabled == 'true'
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_OUTCOME: ${{ steps.react-doctor-pr.outcome }}
          BRANCH_OUTCOME: ${{ steps.react-doctor.outcome }}
        run: |
          OUTCOME="$PR_OUTCOME"
          if [[ -z "$OUTCOME" ]]; then
            OUTCOME="$BRANCH_OUTCOME"
          fi

          STATUS="‚è≠Ô∏è Skipped"
          if [[ "$OUTCOME" == "success" ]]; then
            STATUS="‚úÖ Passed"
          elif [[ "$OUTCOME" == "failure" ]]; then
            STATUS="‚ö†Ô∏è Issues Detected (non-blocking)"
          fi

          echo "### ü©∫ React Doctor" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Status:** $STATUS" >> "$GITHUB_STEP_SUMMARY"
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            echo "- **Mode:** PR diff scan" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Mode:** full scan" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: üßπ Run Trunk Lint
        if: steps.detect-trunk.outputs.enabled == 'true'
        uses: trunk-io/trunk-action@75699af9e26881e564e9d832ef7dc3af25ec031b # v1.2.4
        with:
          check-mode: all

      - name: üßπ Run Lint
        if: steps.detect-trunk.outputs.enabled != 'true'
        uses: navigaite/.github/.github/actions/run-lint@main
        with:
          stack: ${{ needs.setup.outputs.stack }}

  # =============================================================================
  # TEST
  # =============================================================================
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    needs: setup
    if: needs.setup.outputs.enable-test == 'true'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üîß Setup Environment
        uses: navigaite/.github/.github/actions/setup-environment@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          node-version: ${{ needs.setup.outputs.runtime-version }}
          write-summary: 'false'

      - name: üì¶ Install Dependencies
        uses: navigaite/.github/.github/actions/install-dependencies@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          package-manager: ${{ needs.setup.outputs.package-manager }}
          write-summary: 'false'

      - name: üß™ Run Tests
        uses: navigaite/.github/.github/actions/run-tests@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          coverage: true

  # =============================================================================
  # BUILD
  # =============================================================================
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write # SLSA attestation + OIDC
      attestations: write # SLSA build provenance
    needs: [setup, lint, test]
    if: |
      always() &&
      needs.setup.outputs.enable-build == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üîß Setup Environment
        uses: navigaite/.github/.github/actions/setup-environment@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          node-version: ${{ needs.setup.outputs.runtime-version }}
          write-summary: 'false'

      - name: üì¶ Install Dependencies
        uses: navigaite/.github/.github/actions/install-dependencies@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          package-manager: ${{ needs.setup.outputs.package-manager }}
          write-summary: 'false'

      - name: üîç Check Infisical Configuration
        id: infisical-config
        shell: bash
        env:
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_SLUG: ${{ vars.INFISICAL_PROJECT_SLUG || secrets.INFISICAL_PROJECT_SLUG }}
          INFISICAL_ENV_SLUG: ${{ vars.INFISICAL_ENV_SLUG || secrets.INFISICAL_ENV_SLUG }}
        run: |
          if [[ -n "$INFISICAL_CLIENT_ID" && -n "$INFISICAL_CLIENT_SECRET" && -n "$INFISICAL_PROJECT_SLUG" && -n "$INFISICAL_ENV_SLUG" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Infisical configuration incomplete, skipping secrets injection step"
          fi

      - name: üîê Load Infisical Secrets (Universal Auth)
        if: steps.infisical-config.outputs.enabled == 'true'
        uses: Infisical/secrets-action@8802effbe453d0576cd923567dcc2c97a1f54058 # v1.0.15
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          project-slug: ${{ vars.INFISICAL_PROJECT_SLUG || secrets.INFISICAL_PROJECT_SLUG }}
          env-slug: ${{ vars.INFISICAL_ENV_SLUG || secrets.INFISICAL_ENV_SLUG }}
          domain: ${{ vars.INFISICAL_DOMAIN || secrets.INFISICAL_DOMAIN || 'https://app.infisical.com' }}
          secret-path: ${{ vars.INFISICAL_SECRET_PATH || secrets.INFISICAL_SECRET_PATH || '/' }}

      - name: üèóÔ∏è Run Build
        uses: navigaite/.github/.github/actions/run-build@main
        with:
          stack: ${{ needs.setup.outputs.stack }}
          upload-artifacts: false
          attest-artifacts: false

  # =============================================================================
  # DEPLOYMENT (Provider-specific jobs to avoid loading unused actions)
  # =============================================================================
  deploy-vercel:
    name: üöÄ Deploy to ${{ matrix.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      deployments: write
      pull-requests: write
      id-token: write # OIDC for cloud providers
    needs: [setup, build]
    if: |
      always() &&
      needs.setup.outputs.enable-deploy == 'true' &&
      needs.setup.outputs.deploy-provider == 'vercel' &&
      needs.build.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJSON(needs.setup.outputs.deploy-environments).*.name }}
    environment:
      name: ${{ matrix.environment }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üîç Check Infisical Configuration
        id: infisical-config
        shell: bash
        env:
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_SLUG: ${{ vars.INFISICAL_PROJECT_SLUG || secrets.INFISICAL_PROJECT_SLUG }}
          INFISICAL_ENV_SLUG: ${{ vars.INFISICAL_ENV_SLUG || secrets.INFISICAL_ENV_SLUG }}
        run: |
          if [[ -n "$INFISICAL_CLIENT_ID" && -n "$INFISICAL_CLIENT_SECRET" && -n "$INFISICAL_PROJECT_SLUG" && -n "$INFISICAL_ENV_SLUG" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: üîê Load Infisical Secrets (Universal Auth)
        if: steps.infisical-config.outputs.enabled == 'true'
        uses: Infisical/secrets-action@8802effbe453d0576cd923567dcc2c97a1f54058 # v1.0.15
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          project-slug: ${{ vars.INFISICAL_PROJECT_SLUG || secrets.INFISICAL_PROJECT_SLUG }}
          env-slug: ${{ vars.INFISICAL_ENV_SLUG || secrets.INFISICAL_ENV_SLUG }}
          domain: ${{ vars.INFISICAL_DOMAIN || secrets.INFISICAL_DOMAIN || 'https://app.infisical.com' }}
          secret-path: ${{ vars.INFISICAL_SECRET_PATH || secrets.INFISICAL_SECRET_PATH || '/' }}

      - name: üöÄ Deploy to Vercel
        uses: navigaite/.github/.github/actions/deploy-vercel@main
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          environment: ${{ matrix.environment }}
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

  deploy-digitalocean:
    name: üöÄ Deploy to ${{ matrix.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      deployments: write
      pull-requests: write
      id-token: write # OIDC for cloud providers
    needs: [setup, build]
    if: |
      always() &&
      needs.setup.outputs.enable-deploy == 'true' &&
      needs.setup.outputs.deploy-provider == 'digitalocean' &&
      needs.build.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJSON(needs.setup.outputs.deploy-environments).*.name }}
    environment:
      name: ${{ matrix.environment }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üöÄ Deploy to DigitalOcean
        uses: navigaite/.github/.github/actions/deploy-digitalocean@main
        with:
          digitalocean-token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          app-name: ${{ github.event.repository.name }}
          environment: ${{ matrix.environment }}
          is-pr-preview: ${{ matrix.environment == 'preview' && github.event_name == 'pull_request' }}

  deploy-docker:
    name: üöÄ Deploy to ${{ matrix.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      deployments: write
      packages: write
      id-token: write # OIDC for cloud providers
    needs: [setup, build]
    if: |
      always() &&
      needs.setup.outputs.enable-deploy == 'true' &&
      needs.setup.outputs.deploy-provider == 'docker' &&
      needs.build.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJSON(needs.setup.outputs.deploy-environments).*.name }}
    environment:
      name: ${{ matrix.environment }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üöÄ Deploy Docker Image
        uses: navigaite/.github/.github/actions/deploy-docker@main
        with:
          image-name: ${{ github.event.repository.name }}
          image-tag: ${{ github.sha }}
          registry-password: ${{ secrets.DOCKER_REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}
          registry-username: ${{ secrets.DOCKER_REGISTRY_USERNAME || github.actor }}

  # =============================================================================
  # RELEASE MANAGEMENT
  # =============================================================================
  release:
    name: üì¶ Release Management
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      id-token: write # OIDC for release signing
    needs: [setup, build]
    if: |
      always() &&
      needs.setup.outputs.enable-release == 'true' &&
      github.ref == 'refs/heads/main' &&
      needs.build.result == 'success'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: üì¶ Release Please
        uses: navigaite/.github/.github/actions/release-management@main
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          release-type:
            # yamllint disable-line rule:line-length
            ${{ needs.setup.outputs.stack == 'nodejs' && 'node' || needs.setup.outputs.stack == 'python' && 'python' || 'simple' }}
  # =============================================================================
  # SYNC MAIN TO DEV (After Release)
  # =============================================================================
  sync-to-dev:
    name: üîÑ Sync main ‚Üí ${{ needs.setup.outputs.sync-target-branch }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
    needs: [setup, release]
    if: |
      always() &&
      needs.setup.outputs.enable-sync == 'true' &&
      needs.setup.outputs.enable-release == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.release.result == 'success'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

      - name: üîÑ Sync Branches
        uses: navigaite/.github/.github/actions/sync-branches@main
        with:
          source-branch: main
          target-branch: ${{ needs.setup.outputs.sync-target-branch }}
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          create-pr: false
          auto-merge-pr: true
