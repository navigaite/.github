---
name: Create Release PR

run-name: 'Create Release PR | ${{ github.actor }}'

on:
  workflow_call:
    inputs:
      source_branch:
        description: Source branch for the release PR
        required: false
        default: dev
        type: string
      target_branch:
        description: Target branch for the release PR
        required: false
        default: main
        type: string
      draft:
        description: Create as draft PR
        required: false
        default: false
        type: boolean
    secrets:
      github_token:
        description: Optional PAT to create PRs and trigger downstream workflows
        required: false
  workflow_dispatch:
    inputs:
      source_branch:
        description: Source branch for the release PR
        required: true
        default: dev
        type: string
      target_branch:
        description: Target branch for the release PR
        required: true
        default: main
        type: string
      draft:
        description: Create as draft PR
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

jobs:
  create-release-pr:
    name: Create or Update Release PR
    runs-on: ubuntu-latest
    steps:
      - name: Validate branches
        run: |
          set -euo pipefail
          if [ "${{ inputs.source_branch }}" = "${{ inputs.target_branch }}" ]; then
            echo "Source and target branches must be different."
            exit 1
          fi

      - name: Create or update PR
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const source = '${{ inputs.source_branch }}';
            const target = '${{ inputs.target_branch }}';
            const draft = ${{ inputs.draft }};
            const headRef = `${owner}:${source}`;

            const parseSemver = (value) => {
              if (!value || typeof value !== 'string') return null;
              const match = value.trim().match(/^v?(\\d+)\\.(\\d+)\\.(\\d+)$/);
              if (!match) return null;
              return {
                major: Number(match[1]),
                minor: Number(match[2]),
                patch: Number(match[3]),
              };
            };

            const bumpSemver = (version, level) => {
              const parsed = parseSemver(version);
              if (!parsed) return null;
              if (level === 'major') return `${parsed.major + 1}.0.0`;
              if (level === 'minor') return `${parsed.major}.${parsed.minor + 1}.0`;
              return `${parsed.major}.${parsed.minor}.${parsed.patch + 1}`;
            };

            const readPackageVersion = async (ref) => {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner,
                  repo,
                  path: 'package.json',
                  ref,
                });
                if (!data.content) return null;
                const decoded = Buffer.from(data.content, 'base64').toString('utf8');
                const pkg = JSON.parse(decoded);
                return typeof pkg.version === 'string' ? pkg.version : null;
              } catch (_err) {
                return null;
              }
            };

            const compare = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: target,
              head: source,
            });

            const aheadBy = compare.data.ahead_by;
            const commitCount = compare.data.total_commits;
            const compareUrl = compare.data.html_url;

            core.setOutput('ahead_by', String(aheadBy));
            core.setOutput('commit_count', String(commitCount));
            core.setOutput('compare_url', compareUrl);

            if (aheadBy === 0) {
              core.notice(`No changes to release: '${source}' is not ahead of '${target}'.`);
              core.setOutput('status', 'noop');
              return;
            }

            const currentVersion = await readPackageVersion(target);
            const sourceVersion = await readPackageVersion(source);

            let bumpLevel = 'patch';
            const buckets = {
              feat: [],
              fix: [],
              ci: [],
              chore: [],
              docs: [],
              test: [],
              other: [],
            };

            for (const commit of compare.data.commits) {
              const firstLine = commit.commit.message.split('\n')[0];
              if (/^Merge pull request/i.test(firstLine)) {
                continue;
              }
              const line = `- ${commit.sha.slice(0, 7)} ${firstLine}`;

              if (/!:|BREAKING CHANGE/i.test(firstLine)) {
                bumpLevel = 'major';
              } else if (/^feat(\(|:)/i.test(firstLine) && bumpLevel !== 'major') {
                bumpLevel = 'minor';
              }

              if (/^feat(\(|:)/i.test(firstLine)) buckets.feat.push(line);
              else if (/^fix(\(|:)/i.test(firstLine)) buckets.fix.push(line);
              else if (/^(ci|build)(\(|:)/i.test(firstLine)) buckets.ci.push(line);
              else if (/^chore(\(|:)/i.test(firstLine)) buckets.chore.push(line);
              else if (/^docs(\(|:)/i.test(firstLine)) buckets.docs.push(line);
              else if (/^test(\(|:)/i.test(firstLine)) buckets.test.push(line);
              else buckets.other.push(line);
            }

            const projectedVersion =
              sourceVersion && currentVersion && sourceVersion !== currentVersion
                ? sourceVersion
                : bumpSemver(currentVersion, bumpLevel);
            const titleVersion = projectedVersion ? `(v${projectedVersion})` : '';
            const releaseTitle = `release${titleVersion}: ${source} -> ${target}`;

            const section = (name, items, limit = 8) => {
              if (!items.length) return '';
              const visible = items.slice(0, limit);
              const more = items.length > limit ? `\n- ...and ${items.length - limit} more` : '';
              return `### ${name}\n${visible.join('\n')}${more}\n`;
            };

            const additions = (compare.data.files || []).reduce((sum, f) => sum + (f.additions || 0), 0);
            const deletions = (compare.data.files || []).reduce((sum, f) => sum + (f.deletions || 0), 0);
            const changedFiles = compare.data.files?.length || 0;

            const releaseBody = [
              '## Release Promotion',
              '',
              `Automated release PR from \`${source}\` to \`${target}\`.`,
              '',
              '### Version',
              `- Current version: ${currentVersion ? `\`v${currentVersion}\`` : '_not detected_'}`,
              `- Source version: ${sourceVersion ? `\`v${sourceVersion}\`` : '_not detected_'}`,
              `- Projected next version: ${projectedVersion ? `\`v${projectedVersion}\`` : '_not available_'}`,
              '',
              '### Scope',
              `- Source: \`${source}\``,
              `- Target: \`${target}\``,
              `- Commits: ${commitCount}`,
              `- Files changed: ${changedFiles}`,
              `- Diff: +${additions} / -${deletions}`,
              `- Compare: ${compareUrl}`,
              '',
              section('Features', buckets.feat),
              section('Fixes', buckets.fix),
              section('CI / Build', buckets.ci),
              section('Chores', buckets.chore),
              section('Tests', buckets.test),
              section('Other', buckets.other),
              '',
              '### Checklist',
              '- [ ] CI checks are green',
              '- [ ] Preview/development smoke test complete',
              '- [ ] Ready to merge to production',
            ].filter(Boolean).join('\n');

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: target,
              head: headRef,
              per_page: 10,
            });

            const existingPr = existing.data[0];

            if (existingPr) {
              const updated = await github.rest.pulls.update({
                owner,
                repo,
                pull_number: existingPr.number,
                title: releaseTitle,
                body: releaseBody,
              });
              core.setOutput('status', 'updated');
              core.setOutput('pr_number', String(updated.data.number));
              core.setOutput('pr_url', updated.data.html_url);
              return;
            }

            const created = await github.rest.pulls.create({
              owner,
              repo,
              title: releaseTitle,
              head: source,
              base: target,
              body: releaseBody,
              draft,
              maintainer_can_modify: true,
            });

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: created.data.number,
                labels: ['release', 'automated'],
              });
            } catch (err) {
              core.warning(`Could not add labels: ${err.message}`);
            }

            core.setOutput('status', 'created');
            core.setOutput('pr_number', String(created.data.number));
            core.setOutput('pr_url', created.data.html_url);

      - name: Job summary
        run: |
          {
            echo "## ðŸš€ Release PR"
            echo ""
            echo "| Metric | Value |"
            echo "| --- | --- |"
            echo "| Source branch | \`${{ inputs.source_branch }}\` |"
            echo "| Target branch | \`${{ inputs.target_branch }}\` |"
            echo "| Status | \`${{ steps.create_pr.outputs.status || 'unknown' }}\` |"
            echo "| Ahead by | \`${{ steps.create_pr.outputs.ahead_by || '0' }}\` commit(s) |"
            echo "| Compared commits | \`${{ steps.create_pr.outputs.commit_count || '0' }}\` |"
            echo ""
            if [ "${{ steps.create_pr.outputs.status }}" = "created" ] || [ "${{ steps.create_pr.outputs.status }}" = "updated" ]; then
              echo "- PR: ${{ steps.create_pr.outputs.pr_url }}"
            fi
            if [ -n "${{ steps.create_pr.outputs.compare_url }}" ]; then
              echo "- Compare: ${{ steps.create_pr.outputs.compare_url }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
