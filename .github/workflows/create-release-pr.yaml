---
name: Create Release PR

run-name: 'Create Release PR | ${{ github.actor }}'

on:
  workflow_call:
    inputs:
      source_branch:
        description: Source branch for the release PR
        required: false
        default: dev
        type: string
      target_branch:
        description: Target branch for the release PR
        required: false
        default: main
        type: string
      draft:
        description: Create as draft PR
        required: false
        default: false
        type: boolean
    secrets:
      github_token:
        description: Optional PAT to create PRs and trigger downstream workflows
        required: false
  workflow_dispatch:
    inputs:
      source_branch:
        description: Source branch for the release PR
        required: true
        default: dev
        type: string
      target_branch:
        description: Target branch for the release PR
        required: true
        default: main
        type: string
      draft:
        description: Create as draft PR
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

jobs:
  create-release-pr:
    name: Create or Update Release PR
    runs-on: ubuntu-latest
    steps:
      - name: Validate branches
        run: |
          set -euo pipefail
          if [ "${{ inputs.source_branch }}" = "${{ inputs.target_branch }}" ]; then
            echo "Source and target branches must be different."
            exit 1
          fi

      - name: Create or update PR
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const source = '${{ inputs.source_branch }}';
            const target = '${{ inputs.target_branch }}';
            const draft = ${{ inputs.draft }};
            const headRef = `${owner}:${source}`;

            const compare = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: target,
              head: source,
            });

            const aheadBy = compare.data.ahead_by;
            const commitCount = compare.data.total_commits;
            const compareUrl = compare.data.html_url;

            core.setOutput('ahead_by', String(aheadBy));
            core.setOutput('commit_count', String(commitCount));
            core.setOutput('compare_url', compareUrl);

            if (aheadBy === 0) {
              core.notice(`No changes to release: '${source}' is not ahead of '${target}'.`);
              core.setOutput('status', 'noop');
              return;
            }

            const releaseTitle = `release: ${source} -> ${target}`;
            const commitLines = compare.data.commits
              .slice(0, 30)
              .map((c) => {
                const shortSha = c.sha.slice(0, 7);
                const firstLine = c.commit.message.split('\n')[0];
                return `- ${shortSha} ${firstLine}`;
              })
              .join('\n');
            const additionalCount = Math.max(commitCount - 30, 0);

            const releaseBody = [
              '## Release Promotion',
              '',
              `Automated release PR from \`${source}\` to \`${target}\`.`,
              '',
              '### Overview',
              `- Source: \`${source}\``,
              `- Target: \`${target}\``,
              `- Commits: ${commitCount}`,
              `- Compare: ${compareUrl}`,
              '',
              '### Included commits (latest)',
              commitLines || '- (no commit details available)',
              additionalCount > 0 ? `- ...and ${additionalCount} more commit(s)` : '',
              '',
              '### Checklist',
              '- [ ] CI is green',
              '- [ ] QA/preview validated',
              '- [ ] Ready to merge to production',
            ].filter(Boolean).join('\n');

            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: target,
              head: headRef,
              per_page: 10,
            });

            const existingPr = existing.data[0];

            if (existingPr) {
              const updated = await github.rest.pulls.update({
                owner,
                repo,
                pull_number: existingPr.number,
                title: releaseTitle,
                body: releaseBody,
              });
              core.setOutput('status', 'updated');
              core.setOutput('pr_number', String(updated.data.number));
              core.setOutput('pr_url', updated.data.html_url);
              return;
            }

            const created = await github.rest.pulls.create({
              owner,
              repo,
              title: releaseTitle,
              head: source,
              base: target,
              body: releaseBody,
              draft,
              maintainer_can_modify: true,
            });

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: created.data.number,
                labels: ['release', 'automated'],
              });
            } catch (err) {
              core.warning(`Could not add labels: ${err.message}`);
            }

            core.setOutput('status', 'created');
            core.setOutput('pr_number', String(created.data.number));
            core.setOutput('pr_url', created.data.html_url);

      - name: Job summary
        run: |
          {
            echo "## ðŸš€ Release PR"
            echo ""
            echo "| Metric | Value |"
            echo "| --- | --- |"
            echo "| Source branch | \`${{ inputs.source_branch }}\` |"
            echo "| Target branch | \`${{ inputs.target_branch }}\` |"
            echo "| Status | \`${{ steps.create_pr.outputs.status || 'unknown' }}\` |"
            echo "| Ahead by | \`${{ steps.create_pr.outputs.ahead_by || '0' }}\` commit(s) |"
            echo "| Compared commits | \`${{ steps.create_pr.outputs.commit_count || '0' }}\` |"
            echo ""
            if [ "${{ steps.create_pr.outputs.status }}" = "created" ] || [ "${{ steps.create_pr.outputs.status }}" = "updated" ]; then
              echo "- PR: ${{ steps.create_pr.outputs.pr_url }}"
            fi
            if [ -n "${{ steps.create_pr.outputs.compare_url }}" ]; then
              echo "- Compare: ${{ steps.create_pr.outputs.compare_url }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
