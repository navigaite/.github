---
name: Deploy to Vercel
description: Deploy application to Vercel with preview, staging, and production environments

inputs:
  vercel-token:
    description: Vercel API token
    required: true

  vercel-org-id:
    description: Vercel organization ID
    required: true

  vercel-project-id:
    description: Vercel project ID
    required: true

  vercel-scope:
    description: Vercel scope (team slug)
    required: false
    default: ''

  environment:
    description: Deployment environment (preview, staging, production)
    required: true

  github-token:
    description: GitHub token for PR comments and deployments
    required: false
    default: ''

  working-directory:
    description: Working directory
    required: false
    default: .

  build-command:
    description: Custom build command (overrides Vercel project settings)
    required: false
    default: ''

  env-vars:
    description: Environment variables as JSON object
    required: false
    default: '{}'

runs:
  using: composite
  steps:
    - name: Install Vercel CLI
      shell: bash
      run: npm install -g vercel@latest

    - name: Pull Vercel Environment
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "::group::ðŸ“¥ Pulling Vercel Environment"

        VERCEL_ENV="${{ inputs.environment }}"
        VERCEL_ENV_LOWER=$(echo "$VERCEL_ENV" | tr '[:upper:]' '[:lower:]')
        PRODUCTION_FLAG=""
        VERCEL_TARGET="preview"

        # Map pipeline environment names to Vercel target environments.
        # Vercel accepts: production, preview, development.
        case "$VERCEL_ENV_LOWER" in
        production)
          VERCEL_TARGET="production"
          PRODUCTION_FLAG="--prod"
          ;;
        *)
          VERCEL_TARGET="preview"
          ;;
        esac

        # Pull environment information
        vercel pull --yes --environment="$VERCEL_TARGET" --token=${{ inputs.vercel-token }} \
          --scope="${{ inputs.vercel-scope }}" \
          $PRODUCTION_FLAG

        echo "::endgroup::"
      env:
        VERCEL_ORG_ID: ${{ inputs.vercel-org-id }}
        VERCEL_PROJECT_ID: ${{ inputs.vercel-project-id }}

    - name: Build Project
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "::group::ðŸ—ï¸ Building with Vercel"

        VERCEL_ENV="${{ inputs.environment }}"
        VERCEL_ENV_LOWER=$(echo "$VERCEL_ENV" | tr '[:upper:]' '[:lower:]')
        BUILD_CMD="${{ inputs.build-command }}"
        VERCEL_TARGET="preview"

        case "$VERCEL_ENV_LOWER" in
        production) VERCEL_TARGET="production" ;;
        *) VERCEL_TARGET="preview" ;;
        esac

        if [[ -n "$BUILD_CMD" ]]; then
          echo "Using custom build command: $BUILD_CMD"
          vercel build --target="$VERCEL_TARGET" --token=${{ inputs.vercel-token }} --yes
          eval "$BUILD_CMD"
        else
          vercel build --target="$VERCEL_TARGET" --token=${{ inputs.vercel-token }}
        fi

        echo "::endgroup::"
      env:
        VERCEL_ORG_ID: ${{ inputs.vercel-org-id }}
        VERCEL_PROJECT_ID: ${{ inputs.vercel-project-id }}

    - name: Deploy to Vercel
      id: deploy
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        VERCEL_TOKEN: ${{ inputs.vercel-token }}
        VERCEL_SCOPE: ${{ inputs.vercel-scope }}
        VERCEL_ORG_ID: ${{ inputs.vercel-org-id }}
        VERCEL_PROJECT_ID: ${{ inputs.vercel-project-id }}
        ENVIRONMENT: ${{ inputs.environment }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
      run: |
        echo "::group::ðŸš€ Deploying to Vercel ($ENVIRONMENT)"

        VERCEL_ENV_LOWER=$(echo "$ENVIRONMENT" | tr '[:upper:]' '[:lower:]')
        SCOPE_ARG=""
        VERCEL_TARGET="preview"

        if [[ -n "$VERCEL_SCOPE" ]]; then
          SCOPE_ARG="--scope=$VERCEL_SCOPE"
        fi

        case "$VERCEL_ENV_LOWER" in
        production) VERCEL_TARGET="production" ;;
        *) VERCEL_TARGET="preview" ;;
        esac

        # Deploy prebuilt project
        DEPLOY_OUTPUT=$(vercel deploy --prebuilt --target="$VERCEL_TARGET" --token="$VERCEL_TOKEN" $SCOPE_ARG 2>&1)
        DEPLOY_URL=$(printf '%s\n' "$DEPLOY_OUTPUT" | grep -Eo 'https://[^ ]+' | grep -E 'https://[^ ]+\.vercel\.app/?$' | tail -1)
        DASHBOARD_URL=$(printf '%s\n' "$DEPLOY_OUTPUT" | grep -Eo 'https://vercel.com/[^ ]+' | tail -1)
        SAFE_DASHBOARD_URL=""
        if [[ -z "$DEPLOY_URL" ]]; then
          DEPLOY_URL=$(printf '%s\n' "$DEPLOY_OUTPUT" | grep -Eo 'https://[^ ]+' | tail -1)
        fi
        if [[ -z "$DEPLOY_URL" ]]; then
          echo "::error::Could not parse deployment URL from Vercel output"
          exit 1
        fi
        if [[ -z "$DASHBOARD_URL" ]]; then
          INSPECT_OUTPUT=$(vercel inspect "$DEPLOY_URL" --token="$VERCEL_TOKEN" $SCOPE_ARG 2>&1 || true)
          DASHBOARD_URL=$(printf '%s\n' "$INSPECT_OUTPUT" | grep -Eo 'https://vercel.com/[^ ]+' | tail -1)
        fi
        DEPLOYMENT_ID=$(printf '%s\n' "$DASHBOARD_URL" | sed -E 's#/$##' | awk -F'/' '{print $NF}')
        if [[ -n "$DEPLOYMENT_ID" ]] && [[ "$DEPLOYMENT_ID" != *"*"* ]]; then
          SAFE_DASHBOARD_URL="https://vercel.com/dashboard/deployments/$DEPLOYMENT_ID"
        fi
        GITHUB_DEPLOYMENTS_URL="https://github.com/${GITHUB_REPOSITORY}/deployments/activity_log?environment=${ENVIRONMENT}"
        RESOLVED_URL=""
        if [[ -n "$SAFE_DASHBOARD_URL" ]] && [[ "$SAFE_DASHBOARD_URL" == https://* ]] && [[ "$SAFE_DASHBOARD_URL" != *"*"* ]]; then
          RESOLVED_URL="$SAFE_DASHBOARD_URL"
        elif [[ -n "$DASHBOARD_URL" ]] && [[ "$DASHBOARD_URL" == https://* ]] && [[ "$DASHBOARD_URL" != *"*"* ]]; then
          RESOLVED_URL="$DASHBOARD_URL"
        elif [[ -n "$DEPLOY_URL" ]] && [[ "$DEPLOY_URL" == https://* ]] && [[ "$DEPLOY_URL" != *"*"* ]]; then
          RESOLVED_URL="$DEPLOY_URL"
        else
          RESOLVED_URL="$GITHUB_DEPLOYMENTS_URL"
        fi

        echo "deployment-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        echo "dashboard-url=$DASHBOARD_URL" >> $GITHUB_OUTPUT
        echo "safe-dashboard-url=$SAFE_DASHBOARD_URL" >> $GITHUB_OUTPUT
        echo "resolved-url=$RESOLVED_URL" >> $GITHUB_OUTPUT
        echo "âœ… Deployed to: $DEPLOY_URL"

        # Set deployment URL for PR preview
        if [[ "$VERCEL_ENV_LOWER" == "preview" ]] && [[ -n "$PR_NUMBER" ]]; then
          PREVIEW_URL="$DEPLOY_URL"
          echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
        fi

        echo "::endgroup::"

    - name: Create GitHub Deployment
      if: inputs.github-token != ''
      uses: chrnorm/deployment-action@55729fcebec3d284f60f5bcabbd8376437d696b1 # v2.0.7
      id: github-deployment
      with:
        token: ${{ inputs.github-token }}
        environment: ${{ inputs.environment }}
        environment-url: ${{ steps.deploy.outputs.resolved-url }}
        auto-merge: false

    - name: Update Deployment Status
      if: inputs.github-token != '' && always()
      uses: chrnorm/deployment-status@9a72af4586197112e0491ea843682b5dc280d806 # v2.0.3
      with:
        token: ${{ inputs.github-token }}
        deployment-id: ${{ steps.github-deployment.outputs.deployment_id }}
        state: ${{ job.status == 'success' && 'success' || 'failure' }}
        environment-url: ${{ steps.deploy.outputs.resolved-url }}

    - name: Comment on PR
      if: inputs.github-token != '' && inputs.environment == 'preview' && github.event_name == 'pull_request'
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const deploymentUrl = '${{ steps.deploy.outputs.deployment-url }}';
          const comment = `### ðŸš€ Vercel Preview Deployment

          **Environment:** Preview
          **URL:** ${deploymentUrl}
          **Commit:** ${context.sha.substring(0, 7)}

          ---
          <sub>Deployed with [Vercel](https://vercel.com)</sub>`;

          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' && comment.body.includes('Vercel Preview Deployment')
          );

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

    - name: Deployment Summary
      if: always()
      shell: bash
      env:
        DEPLOY_URL: ${{ steps.deploy.outputs.deployment-url }}
        DASHBOARD_URL: ${{ steps.deploy.outputs.dashboard-url }}
        SAFE_DASHBOARD_URL: ${{ steps.deploy.outputs.safe-dashboard-url }}
        RESOLVED_URL: ${{ steps.deploy.outputs.resolved-url }}
        ENVIRONMENT: ${{ inputs.environment }}
        DEPLOY_STATUS: ${{ steps.deploy.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}
      run: |
        {
          echo "### ðŸš€ Vercel Deployment"
          echo ""
          echo "| Item | Value |"
          echo "| --- | --- |"
          echo "| Environment | \`$ENVIRONMENT\` |"
          echo "| Status | $DEPLOY_STATUS |"
          echo "| URL | \`$RESOLVED_URL\` |"
          echo ""
          echo "[Open Deployment]($RESOLVED_URL)"
        } >> "$GITHUB_STEP_SUMMARY"

outputs:
  deployment-url:
    description: The URL of the Vercel deployment
    value: ${{ steps.deploy.outputs.deployment-url }}

  safe-dashboard-url:
    description: Mask-safe Vercel dashboard URL for this deployment
    value: ${{ steps.deploy.outputs.safe-dashboard-url }}

  resolved-url:
    description: Best available URL (Vercel if safe, else GitHub deployments page)
    value: ${{ steps.deploy.outputs.resolved-url }}

  dashboard-url:
    description: The Vercel dashboard URL for this deployment
    value: ${{ steps.deploy.outputs.dashboard-url }}

  preview-url:
    description: The preview URL (for PR deployments)
    value: ${{ steps.deploy.outputs.preview-url }}
