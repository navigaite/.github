---
name: Deploy Docker Container
description: Build and deploy Docker container to any registry

inputs:
  dockerfile:
    description: Path to Dockerfile
    required: false
    default: Dockerfile

  context:
    description: Build context
    required: false
    default: .

  image-name:
    description: Docker image name
    required: true

  image-tag:
    description: Docker image tag
    required: false
    default: ${{ github.sha }}

  registry:
    description: Container registry (dockerhub, ghcr, gcr, ecr, custom)
    required: false
    default: ghcr

  registry-url:
    description: Custom registry URL (for custom registry type)
    required: false
    default: ''

  registry-username:
    description: Registry username
    required: false
    default: ''

  registry-password:
    description: Registry password/token
    required: true

  build-args:
    description: Build arguments as multiline string
    required: false
    default: ''

  platforms:
    description: Target platforms (e.g., linux/amd64,linux/arm64)
    required: false
    default: linux/amd64

  push:
    description: Push image to registry
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    - name: Set up QEMU
      if: contains(inputs.platforms, ',')
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@f7ce87c1d6bead3e36075b2ce75da1f6cc28aaca # v3.9.0

    - name: Determine Registry Configuration
      id: registry-config
      shell: bash
      env:
        REGISTRY_TYPE: ${{ inputs.registry }}
        INPUT_USERNAME: ${{ inputs.registry-username }}
        INPUT_REGISTRY_URL: ${{ inputs.registry-url }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        REGISTRY="$REGISTRY_TYPE"
        REGISTRY_URL=""
        USERNAME="$INPUT_USERNAME"

        case "$REGISTRY" in
          dockerhub)
            REGISTRY_URL="docker.io"
            ;;
          ghcr)
            REGISTRY_URL="ghcr.io"
            [[ -z "$USERNAME" ]] && USERNAME="$GITHUB_ACTOR"
            ;;
          gcr)
            REGISTRY_URL="gcr.io"
            ;;
          ecr)
            # ECR URL is region-specific
            REGISTRY_URL="$INPUT_REGISTRY_URL"
            ;;
          custom)
            REGISTRY_URL="$INPUT_REGISTRY_URL"
            ;;
          *)
            echo "::error::Unknown registry type: $REGISTRY"
            exit 1
            ;;
        esac

        echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT
        echo "username=$USERNAME" >> $GITHUB_OUTPUT
        echo "Using registry: $REGISTRY_URL"

    - name: Login to Container Registry
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: ${{ steps.registry-config.outputs.registry-url }}
        username: ${{ steps.registry-config.outputs.username }}
        password: ${{ inputs.registry-password }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
      with:
        images: ${{ steps.registry-config.outputs.registry-url }}/${{ inputs.image-name }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=${{ inputs.image-tag }}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and Push Docker Image
      id: build
      uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75 # v6.9.0
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.platforms }}
        push: ${{ inputs.push }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: ${{ inputs.build-args }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deployment Summary
      if: always()
      shell: bash
      env:
        IMAGE_NAME: ${{ inputs.image-name }}
        IMAGE_TAG: ${{ inputs.image-tag }}
        REGISTRY_URL: ${{ steps.registry-config.outputs.registry-url }}
        PLATFORMS: ${{ inputs.platforms }}
        BUILD_DIGEST: ${{ steps.build.outputs.digest }}
        BUILD_OUTCOME: ${{ steps.build.outcome }}
      run: |
        echo "### ðŸ³ Docker Build & Deploy" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Image:** $IMAGE_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
        echo "- **Registry:** $REGISTRY_URL" >> $GITHUB_STEP_SUMMARY
        echo "- **Platforms:** $PLATFORMS" >> $GITHUB_STEP_SUMMARY
        echo "- **Digest:** \`$BUILD_DIGEST\`" >> $GITHUB_STEP_SUMMARY
        STATUS=$([[ "$BUILD_OUTCOME" == "success" ]] && echo "âœ… Success" || echo "âŒ Failed")
        echo "- **Status:** $STATUS" >> $GITHUB_STEP_SUMMARY

outputs:
  image-digest:
    description: Image digest
    value: ${{ steps.build.outputs.digest }}

  image-tags:
    description: Image tags
    value: ${{ steps.meta.outputs.tags }}
